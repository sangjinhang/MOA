<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>🚀 小勇士单词消消乐（Excel版） 🚀</title>
  <style>
    body {
      font-family: "Comic Sans MS", cursive, sans-serif;
      text-align: center;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 10px;
    }
    .container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      width: 90%;
      max-width: 1100px;
    }
    .game-board {
      display: grid;
      grid-template-columns: repeat(4, 160px);
      gap: 12px;
      justify-content: center;
      background: #2196f3;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
      min-height: 460px; /* 给个最小高度，让未开始游戏时也有框 */
    }
    .card {
      width: 160px;
      height: 160px;
      background: #ffeb3b;
      color: #222;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      border: 4px solid #fbc02d;
      transition: transform 0.2s, background 0.3s;
      box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    .card:hover {
      transform: scale(1.05);
    }
    .card.selected {
      background: #ff9800;
      transform: scale(1.1);
    }
    .matched {
      background: #4caf50;
      pointer-events: none;
      animation: fadeOut 0.4s forwards;
    }
    .wrong {
      background: red !important;
      animation: shake 0.3s;
    }
    @keyframes fadeOut {
      100% {
        opacity: 0;
        visibility: hidden;
        transform: scale(0.8);
      }
    }
    @keyframes shake {
      0%   { transform: translateX(0); }
      25%  { transform: translateX(-5px); }
      50%  { transform: translateX(5px); }
      75%  { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    .leaderboard {
      background: #ffffff;
      color: #222;
      padding: 15px;
      border-radius: 15px;
      width: 250px;
      box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.3);
      margin-left: 20px;
      text-align: left;
      height: fit-content;
    }
    .leaderboard h2 {
      text-align: center;
      color: #ff4081;
    }
    .leaderboard ul {
      list-style: none;
      padding: 0;
    }
    .leaderboard li {
      font-size: 18px;
      padding: 5px 0;
    }

    .buttons {
      margin: 10px 0;
    }
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      margin: 0 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn-upload {
      background: #ff9800;
      color: #fff;
    }
    .btn-start {
      background: #4caf50;
      color: #fff;
    }
  </style>
</head>
<body>
  <h1>🚀 小勇士单词消消乐（Excel导入） 🚀</h1>
  
  <div class="buttons">
    <!-- Excel 文件输入 -->
    <input type="file" id="excelFile" accept=".xls,.xlsx" class="btn btn-upload" />
    <!-- 开始游戏按钮 -->
    <button id="startBtn" class="btn btn-start" disabled>开始游戏</button>
  </div>

  <h2>关卡: <span id="level">1</span></h2>
  <h2>时间: <span id="timer">0.00</span> 秒</h2>
  <h3>✅ 已匹配成功：<span id="matchedCount">0</span> 组单词</h3>
  
  <div class="container">
    <div class="game-board" id="gameBoard">
      <!-- 未开始游戏时，这里为空；导入Excel后，点击开始生成卡片 -->
    </div>
    <div class="leaderboard">
      <h2>🎖️ 排行榜 🎖️</h2>
      <ul id="leaderboardList"></ul>
    </div>
  </div>
  
  <!-- 音效文件 -->
  <audio id="matchSound" src="1.MP3"></audio>
  <audio id="wrongSound" src="2.MP3"></audio>
  
  <!-- SheetJS 用于前端解析 Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // ====== 变量们 ======
    let allWords = [];          // Excel 导入后存放 {en, cn} 的数组
    let usedWords = [];         // 已使用过的英文单词
    let currentWords = [];      // 当前关卡选出的 8 组单词
    let cards = [];             // 生成的卡片（16张）
    let flippedCards = [];      // 已翻开的卡片
    let timer = 0.00;           // 计时
    let timerInterval = null;
    let level = 1;              // 关卡数
    let matchedCount = 0;       // 累计匹配成功数量
    let leaderboard = [];       // 排行榜，记录各关 { time, mistakes }
    let mistakesThisRound = 0;  // 本关错误次数

    // ====== Excel文件解析 ======
    const fileInput = document.getElementById("excelFile");
    const startBtn  = document.getElementById("startBtn");

    fileInput.addEventListener("change", handleFile, false);
    startBtn.addEventListener("click", createGameBoard);

    /**
     * 解析 Excel 文件
     */
    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      // 用 FileReader 读成 arrayBuffer
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        // 用 SheetJS 解析
        const workbook = XLSX.read(data, { type: 'array' });
        // 取第一个 sheet
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        // 转成二维数组（每行一个数组 [A列, B列]）
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // 清空 allWords
        allWords = [];
        usedWords = [];
        matchedCount = 0;
        level = 1;
        leaderboard = [];
        mistakesThisRound = 0;
        document.getElementById("matchedCount").innerText = "0";
        document.getElementById("level").innerText = "1";

        // 从 jsonData 第1行到最后（可能第0行是表头）
        // 如果没有表头，可直接从 jsonData[0] 开始
        // 假设: A列英文, B列中文
        // 先检测第一行是否是表头
        // 如果确定A1、B1就是数据，那就不跳过
        // 这里示例：假设第1行就是数据
        for (let i = 0; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (row[0] && row[1]) {
            allWords.push({ en: row[0], cn: row[1] });
          }
        }
        alert("Excel 导入成功！共 " + allWords.length + " 条单词。");
        
        // 允许开始游戏
        startBtn.disabled = false;
      };
      reader.readAsArrayBuffer(file);
    }

    // ====== 开始游戏 & 创建关卡 ======
    function createGameBoard() {
      // 若词库为空，提示先导入
      if (allWords.length === 0) {
        alert("请先导入含有单词的 Excel 文件！");
        return;
      }
      // 清除前面关卡的卡片
      const gameBoard = document.getElementById("gameBoard");
      gameBoard.innerHTML = "";

      // 判断单词是否已经用完
      if (usedWords.length >= allWords.length) {
        alert("🎉 游戏结束！所有单词都用完了。总匹配：" + matchedCount + " 组单词！");
        return;
      }

      // 重置本关错误次数
      mistakesThisRound = 0;

      // 从剩余单词中随机取 8 组(16张卡片)
      let availableWords = allWords.filter(word => !usedWords.includes(word.en));
      shuffle(availableWords);
      currentWords = availableWords.slice(0, 8);

      // 记录已使用的英文单词
      usedWords.push(...currentWords.map(word => word.en));

      // 生成卡片数组
      cards = [];
      currentWords.forEach(word => {
        cards.push({ text: word.en, pair: word.cn });
        cards.push({ text: word.cn, pair: word.en });
      });
      shuffle(cards);

      // 渲染到页面
      cards.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.classList.add("card");
        cardElement.dataset.text = card.text;
        cardElement.dataset.pair = card.pair;
        cardElement.innerText = card.text;
        cardElement.addEventListener("click", flipCard);
        gameBoard.appendChild(cardElement);
      });

      // 重新计时
      timer = 0.00;
      clearInterval(timerInterval);
      startTimer();
    }

    // ====== 计时器 ======
    function startTimer() {
      document.getElementById("timer").innerText = timer.toFixed(2);
      timerInterval = setInterval(() => {
        timer += 0.01;
        document.getElementById("timer").innerText = timer.toFixed(2);
      }, 10);
    }

    // ====== 洗牌工具 ======
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // ====== 发音 ======
    function speakEnglish(word) {
      let utterance1 = new SpeechSynthesisUtterance(word);
      utterance1.lang = "en-US";
      utterance1.rate = 0.9;

      speechSynthesis.speak(utterance1);
      // 第二次
      let utterance2 = new SpeechSynthesisUtterance(word);
      utterance2.lang = "en-US";
      utterance2.rate = 0.9;
      speechSynthesis.speak(utterance2);
    }

    // ====== 翻牌 ======
    function flipCard() {
      if (flippedCards.length === 2) return;
      if (this.classList.contains("matched")) return;

      this.classList.add("selected");
      flippedCards.push(this);

      if (flippedCards.length === 2) {
        setTimeout(checkMatch, 400);
      }
    }

    // ====== 检查匹配 ======
    function checkMatch() {
      const [card1, card2] = flippedCards;
      const matchSound = document.getElementById("matchSound");
      const wrongSound = document.getElementById("wrongSound");

      // 匹配成功
      if (card1.dataset.text === card2.dataset.pair) {
        card1.classList.add("matched");
        card2.classList.add("matched");
        matchSound.play();

        // 发音：找出英语
        let englishText = "";
        if (currentWords.some(w => w.en === card1.dataset.text)) {
          englishText = card1.dataset.text;
        } else if (currentWords.some(w => w.en === card2.dataset.text)) {
          englishText = card2.dataset.text;
        }
        if (englishText) speakEnglish(englishText);

        // 累计匹配
        matchedCount++;
        document.getElementById("matchedCount").innerText = matchedCount;

        // 判断是否全部匹配
        const matchedCards = document.querySelectorAll(".matched");
        if (matchedCards.length === cards.length) {
          setTimeout(() => {
            clearInterval(timerInterval);
            // 记录到排行榜
            leaderboard.push({ time: timer, mistakes: mistakesThisRound });
            updateLeaderboard();

            level++;
            document.getElementById("level").innerText = level;

            setTimeout(createGameBoard, 500);
          }, 400);
        }
      }
      // 匹配失败
      else {
        wrongSound.play();
        mistakesThisRound++;
        card1.classList.add("wrong");
        card2.classList.add("wrong");
        setTimeout(() => {
          card1.classList.remove("selected", "wrong");
          card2.classList.remove("selected", "wrong");
        }, 400);
      }
      flippedCards = [];
    }

    // ====== 更新排行榜 ======
    function updateLeaderboard() {
      const list = document.getElementById("leaderboardList");
      list.innerHTML = "";
      leaderboard.forEach((round, index) => {
        let li = document.createElement("li");
        li.innerText = `第${index + 1}关：${round.time.toFixed(2)}秒，错误：${round.mistakes}次`;
        list.appendChild(li);
      });
    }
  </script>
</body>
</html>
