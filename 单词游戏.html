<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ğŸš€ å°å‹‡å£«å•è¯æ¶ˆæ¶ˆä¹ï¼ˆExcelç‰ˆï¼‰ ğŸš€</title>
  <style>
    body {
      font-family: "Comic Sans MS", cursive, sans-serif;
      text-align: center;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 10px;
    }
    .container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      width: 90%;
      max-width: 1100px;
    }
    .game-board {
      display: grid;
      grid-template-columns: repeat(4, 160px);
      gap: 12px;
      justify-content: center;
      background: #2196f3;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
      min-height: 460px; /* ç»™ä¸ªæœ€å°é«˜åº¦ï¼Œè®©æœªå¼€å§‹æ¸¸æˆæ—¶ä¹Ÿæœ‰æ¡† */
    }
    .card {
      width: 160px;
      height: 160px;
      background: #ffeb3b;
      color: #222;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      border: 4px solid #fbc02d;
      transition: transform 0.2s, background 0.3s;
      box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    .card:hover {
      transform: scale(1.05);
    }
    .card.selected {
      background: #ff9800;
      transform: scale(1.1);
    }
    .matched {
      background: #4caf50;
      pointer-events: none;
      animation: fadeOut 0.4s forwards;
    }
    .wrong {
      background: red !important;
      animation: shake 0.3s;
    }
    @keyframes fadeOut {
      100% {
        opacity: 0;
        visibility: hidden;
        transform: scale(0.8);
      }
    }
    @keyframes shake {
      0%   { transform: translateX(0); }
      25%  { transform: translateX(-5px); }
      50%  { transform: translateX(5px); }
      75%  { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    .leaderboard {
      background: #ffffff;
      color: #222;
      padding: 15px;
      border-radius: 15px;
      width: 250px;
      box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.3);
      margin-left: 20px;
      text-align: left;
      height: fit-content;
    }
    .leaderboard h2 {
      text-align: center;
      color: #ff4081;
    }
    .leaderboard ul {
      list-style: none;
      padding: 0;
    }
    .leaderboard li {
      font-size: 18px;
      padding: 5px 0;
    }

    .buttons {
      margin: 10px 0;
    }
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      margin: 0 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .btn-upload {
      background: #ff9800;
      color: #fff;
    }
    .btn-start {
      background: #4caf50;
      color: #fff;
    }
  </style>
</head>
<body>
  <h1>ğŸš€ å°å‹‡å£«å•è¯æ¶ˆæ¶ˆä¹ï¼ˆExcelå¯¼å…¥ï¼‰ ğŸš€</h1>
  
  <div class="buttons">
    <!-- Excel æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="excelFile" accept=".xls,.xlsx" class="btn btn-upload" />
    <!-- å¼€å§‹æ¸¸æˆæŒ‰é’® -->
    <button id="startBtn" class="btn btn-start" disabled>å¼€å§‹æ¸¸æˆ</button>
  </div>

  <h2>å…³å¡: <span id="level">1</span></h2>
  <h2>æ—¶é—´: <span id="timer">0.00</span> ç§’</h2>
  <h3>âœ… å·²åŒ¹é…æˆåŠŸï¼š<span id="matchedCount">0</span> ç»„å•è¯</h3>
  
  <div class="container">
    <div class="game-board" id="gameBoard">
      <!-- æœªå¼€å§‹æ¸¸æˆæ—¶ï¼Œè¿™é‡Œä¸ºç©ºï¼›å¯¼å…¥Excelåï¼Œç‚¹å‡»å¼€å§‹ç”Ÿæˆå¡ç‰‡ -->
    </div>
    <div class="leaderboard">
      <h2>ğŸ–ï¸ æ’è¡Œæ¦œ ğŸ–ï¸</h2>
      <ul id="leaderboardList"></ul>
    </div>
  </div>
  
  <!-- éŸ³æ•ˆæ–‡ä»¶ -->
  <audio id="matchSound" src="1.MP3"></audio>
  <audio id="wrongSound" src="2.MP3"></audio>
  
  <!-- SheetJS ç”¨äºå‰ç«¯è§£æ Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // ====== å˜é‡ä»¬ ======
    let allWords = [];          // Excel å¯¼å…¥åå­˜æ”¾ {en, cn} çš„æ•°ç»„
    let usedWords = [];         // å·²ä½¿ç”¨è¿‡çš„è‹±æ–‡å•è¯
    let currentWords = [];      // å½“å‰å…³å¡é€‰å‡ºçš„ 8 ç»„å•è¯
    let cards = [];             // ç”Ÿæˆçš„å¡ç‰‡ï¼ˆ16å¼ ï¼‰
    let flippedCards = [];      // å·²ç¿»å¼€çš„å¡ç‰‡
    let timer = 0.00;           // è®¡æ—¶
    let timerInterval = null;
    let level = 1;              // å…³å¡æ•°
    let matchedCount = 0;       // ç´¯è®¡åŒ¹é…æˆåŠŸæ•°é‡
    let leaderboard = [];       // æ’è¡Œæ¦œï¼Œè®°å½•å„å…³ { time, mistakes }
    let mistakesThisRound = 0;  // æœ¬å…³é”™è¯¯æ¬¡æ•°

    // ====== Excelæ–‡ä»¶è§£æ ======
    const fileInput = document.getElementById("excelFile");
    const startBtn  = document.getElementById("startBtn");

    fileInput.addEventListener("change", handleFile, false);
    startBtn.addEventListener("click", createGameBoard);

    /**
     * è§£æ Excel æ–‡ä»¶
     */
    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      // ç”¨ FileReader è¯»æˆ arrayBuffer
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        // ç”¨ SheetJS è§£æ
        const workbook = XLSX.read(data, { type: 'array' });
        // å–ç¬¬ä¸€ä¸ª sheet
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        // è½¬æˆäºŒç»´æ•°ç»„ï¼ˆæ¯è¡Œä¸€ä¸ªæ•°ç»„ [Aåˆ—, Båˆ—]ï¼‰
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // æ¸…ç©º allWords
        allWords = [];
        usedWords = [];
        matchedCount = 0;
        level = 1;
        leaderboard = [];
        mistakesThisRound = 0;
        document.getElementById("matchedCount").innerText = "0";
        document.getElementById("level").innerText = "1";

        // ä» jsonData ç¬¬1è¡Œåˆ°æœ€åï¼ˆå¯èƒ½ç¬¬0è¡Œæ˜¯è¡¨å¤´ï¼‰
        // å¦‚æœæ²¡æœ‰è¡¨å¤´ï¼Œå¯ç›´æ¥ä» jsonData[0] å¼€å§‹
        // å‡è®¾: Aåˆ—è‹±æ–‡, Båˆ—ä¸­æ–‡
        // å…ˆæ£€æµ‹ç¬¬ä¸€è¡Œæ˜¯å¦æ˜¯è¡¨å¤´
        // å¦‚æœç¡®å®šA1ã€B1å°±æ˜¯æ•°æ®ï¼Œé‚£å°±ä¸è·³è¿‡
        // è¿™é‡Œç¤ºä¾‹ï¼šå‡è®¾ç¬¬1è¡Œå°±æ˜¯æ•°æ®
        for (let i = 0; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (row[0] && row[1]) {
            allWords.push({ en: row[0], cn: row[1] });
          }
        }
        alert("Excel å¯¼å…¥æˆåŠŸï¼å…± " + allWords.length + " æ¡å•è¯ã€‚");
        
        // å…è®¸å¼€å§‹æ¸¸æˆ
        startBtn.disabled = false;
      };
      reader.readAsArrayBuffer(file);
    }

    // ====== å¼€å§‹æ¸¸æˆ & åˆ›å»ºå…³å¡ ======
    function createGameBoard() {
      // è‹¥è¯åº“ä¸ºç©ºï¼Œæç¤ºå…ˆå¯¼å…¥
      if (allWords.length === 0) {
        alert("è¯·å…ˆå¯¼å…¥å«æœ‰å•è¯çš„ Excel æ–‡ä»¶ï¼");
        return;
      }
      // æ¸…é™¤å‰é¢å…³å¡çš„å¡ç‰‡
      const gameBoard = document.getElementById("gameBoard");
      gameBoard.innerHTML = "";

      // åˆ¤æ–­å•è¯æ˜¯å¦å·²ç»ç”¨å®Œ
      if (usedWords.length >= allWords.length) {
        alert("ğŸ‰ æ¸¸æˆç»“æŸï¼æ‰€æœ‰å•è¯éƒ½ç”¨å®Œäº†ã€‚æ€»åŒ¹é…ï¼š" + matchedCount + " ç»„å•è¯ï¼");
        return;
      }

      // é‡ç½®æœ¬å…³é”™è¯¯æ¬¡æ•°
      mistakesThisRound = 0;

      // ä»å‰©ä½™å•è¯ä¸­éšæœºå– 8 ç»„(16å¼ å¡ç‰‡)
      let availableWords = allWords.filter(word => !usedWords.includes(word.en));
      shuffle(availableWords);
      currentWords = availableWords.slice(0, 8);

      // è®°å½•å·²ä½¿ç”¨çš„è‹±æ–‡å•è¯
      usedWords.push(...currentWords.map(word => word.en));

      // ç”Ÿæˆå¡ç‰‡æ•°ç»„
      cards = [];
      currentWords.forEach(word => {
        cards.push({ text: word.en, pair: word.cn });
        cards.push({ text: word.cn, pair: word.en });
      });
      shuffle(cards);

      // æ¸²æŸ“åˆ°é¡µé¢
      cards.forEach(card => {
        const cardElement = document.createElement("div");
        cardElement.classList.add("card");
        cardElement.dataset.text = card.text;
        cardElement.dataset.pair = card.pair;
        cardElement.innerText = card.text;
        cardElement.addEventListener("click", flipCard);
        gameBoard.appendChild(cardElement);
      });

      // é‡æ–°è®¡æ—¶
      timer = 0.00;
      clearInterval(timerInterval);
      startTimer();
    }

    // ====== è®¡æ—¶å™¨ ======
    function startTimer() {
      document.getElementById("timer").innerText = timer.toFixed(2);
      timerInterval = setInterval(() => {
        timer += 0.01;
        document.getElementById("timer").innerText = timer.toFixed(2);
      }, 10);
    }

    // ====== æ´—ç‰Œå·¥å…· ======
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // ====== å‘éŸ³ ======
    function speakEnglish(word) {
      let utterance1 = new SpeechSynthesisUtterance(word);
      utterance1.lang = "en-US";
      utterance1.rate = 0.9;

      speechSynthesis.speak(utterance1);
      // ç¬¬äºŒæ¬¡
      let utterance2 = new SpeechSynthesisUtterance(word);
      utterance2.lang = "en-US";
      utterance2.rate = 0.9;
      speechSynthesis.speak(utterance2);
    }

    // ====== ç¿»ç‰Œ ======
    function flipCard() {
      if (flippedCards.length === 2) return;
      if (this.classList.contains("matched")) return;

      this.classList.add("selected");
      flippedCards.push(this);

      if (flippedCards.length === 2) {
        setTimeout(checkMatch, 400);
      }
    }

    // ====== æ£€æŸ¥åŒ¹é… ======
    function checkMatch() {
      const [card1, card2] = flippedCards;
      const matchSound = document.getElementById("matchSound");
      const wrongSound = document.getElementById("wrongSound");

      // åŒ¹é…æˆåŠŸ
      if (card1.dataset.text === card2.dataset.pair) {
        card1.classList.add("matched");
        card2.classList.add("matched");
        matchSound.play();

        // å‘éŸ³ï¼šæ‰¾å‡ºè‹±è¯­
        let englishText = "";
        if (currentWords.some(w => w.en === card1.dataset.text)) {
          englishText = card1.dataset.text;
        } else if (currentWords.some(w => w.en === card2.dataset.text)) {
          englishText = card2.dataset.text;
        }
        if (englishText) speakEnglish(englishText);

        // ç´¯è®¡åŒ¹é…
        matchedCount++;
        document.getElementById("matchedCount").innerText = matchedCount;

        // åˆ¤æ–­æ˜¯å¦å…¨éƒ¨åŒ¹é…
        const matchedCards = document.querySelectorAll(".matched");
        if (matchedCards.length === cards.length) {
          setTimeout(() => {
            clearInterval(timerInterval);
            // è®°å½•åˆ°æ’è¡Œæ¦œ
            leaderboard.push({ time: timer, mistakes: mistakesThisRound });
            updateLeaderboard();

            level++;
            document.getElementById("level").innerText = level;

            setTimeout(createGameBoard, 500);
          }, 400);
        }
      }
      // åŒ¹é…å¤±è´¥
      else {
        wrongSound.play();
        mistakesThisRound++;
        card1.classList.add("wrong");
        card2.classList.add("wrong");
        setTimeout(() => {
          card1.classList.remove("selected", "wrong");
          card2.classList.remove("selected", "wrong");
        }, 400);
      }
      flippedCards = [];
    }

    // ====== æ›´æ–°æ’è¡Œæ¦œ ======
    function updateLeaderboard() {
      const list = document.getElementById("leaderboardList");
      list.innerHTML = "";
      leaderboard.forEach((round, index) => {
        let li = document.createElement("li");
        li.innerText = `ç¬¬${index + 1}å…³ï¼š${round.time.toFixed(2)}ç§’ï¼Œé”™è¯¯ï¼š${round.mistakes}æ¬¡`;
        list.appendChild(li);
      });
    }
  </script>
</body>
</html>
